{
 "build_module" : "builder",
 "items" : [
  {
   "$ xns" : "Gtk",
   "gboolean deletable" : true,
   "gboolean modal" : true,
   "gint default_height" : 500,
   "gint default_width" : 750,
   "id" : "DialogPluginWebkit",
   "items" : [
    {
     "$ pack" : "get_content_area().add",
     "$ xns" : "Gtk",
     "Gtk.Orientation orientation" : "Gtk.Orientation.VERTICAL",
     "gboolean homogeneous" : false,
     "items" : [
      {
       "$ xns" : "Gtk",
       "* init" : [
        "  this.el.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.AUTOMATIC);",
        " ",
        ""
       ],
       "* pack" : "pack_start,false,true,3",
       "gboolean expand" : true,
       "items" : [
        {
         "$ xns" : "WebKit",
         "* init" : [
          " {",
          "    // this may not work!?",
          "    var settings =  this.el.get_settings();",
          "    settings.enable_write_console_messages_to_stdout = true;",
          "     ",
          "    var fs= new FakeServer(this.el);",
          "    fs.ref();",
          "    // this was an attempt to change the url perms.. did not work..",
          "    // settings.enable_file_access_from_file_uris = true;",
          "    // settings.enable_offline_web_application_cache - true;",
          "    // settings.enable_universal_access_from_file_uris = true;",
          "   ",
          "     ",
          "    ",
          "    ",
          "    ",
          "",
          "     // FIXME - base url of script..",
          "     // we need it so some of the database features work.",
          "    this.el.load_html( \"Render not ready\" , ",
          "            //fixme - should be a config option!",
          "            // or should we catch stuff and fix it up..",
          "            \"xhttp://localhost/roobuilder/\"",
          "    );",
          "        ",
          "        ",
          "    ",
          "    ",
          "}",
          ""
         ],
         "* pack" : "add",
         "id" : "webview",
         "listeners" : {
          "script_dialog" : [
           " (dialog) => {",
           "    if (this.el == null) {",
           "        return true;",
           "    }",
           "    ",
           "     var msg = dialog.get_message();",
           "     if (msg.length < 4) {",
           "        return false;",
           "     }",
           "     if (msg.substring(0,4) != \"IPC:\") {",
           "         return false;",
           "     }",
           "     var ar = msg.split(\":\", 3);",
           "    if (ar.length < 3) {",
           "        return false;",
           "    }",
           "    print(\"CMD: %s\\n\",ar[1]);",
           "    print(\"ARGS: %s\\n\",ar[2]);",
           "    switch(ar[1]) {",
           "    ",
           "        case \"SAVEHTML\":",
           "            // print(\"%sw\",ar[2]);",
           "            //  _this.file.saveHTML(ar[2]);",
           "            return true;",
           "            ",
           "        case \"OUT\":",
           "            _this.result_json = ar[2];",
           "            return true;",
           "            ",
           "        default:",
           "            return true;",
           "    }",
           "    ",
           "}"
          ]
         },
         "xtype" : "WebView"
        }
       ],
       "xtype" : "ScrolledWindow"
      }
     ],
     "xtype" : "Box"
    },
    {
     "$ xns" : "Gtk",
     "* pack" : "add_action_widget,3",
     "label" : "Reload",
     "xtype" : "Button"
    },
    {
     "$ xns" : "Gtk",
     "* pack" : "add_action_widget,0",
     "label" : "Cancel",
     "xtype" : "Button"
    },
    {
     "$ xns" : "Gtk",
     "* pack" : "add_action_widget,1",
     "label" : "OK",
     "xtype" : "Button"
    }
   ],
   "listeners" : {
    "delete_event" : [
     "(self, event) => {",
     "    this.el.hide();",
     "    return true; ",
     "    //test  ",
     "}  "
    ]
   },
   "string result_json" : "",
   "string tmpjs" : "",
   "utf8 title" : "Add / Edit Component",
   "xtype" : "Dialog",
   "| bool has_plugin" : [
    "(string cls) {",
    "",
    "     return GLib.FileUtils.test(",
    "            BuilderApplication.configDirectory() + \"/resources/Editors/Editor.\" + cls + \".js\",",
    "            GLib.FileTest.IS_REGULAR",
    "      );",
    "    ",
    "",
    "",
    "}",
    ""
   ],
   "| string show" : [
    " (Gtk.Window ?parent, Project.Project project, string cls, string tbl) {// JsRender.Node node) {",
    " ",
    "    if (parent  != null) {",
    "        this.el.set_transient_for(parent);",
    "        this.el.modal = true;",
    "    }",
    "    this.result_json = \"\";",
    "     var  db = project.roo_database;",
    "     ",
    "    ",
    "     this.el.show_all();",
    "     var   ret = \"\";",
    "     while (true) {",
    "    ",
    "        var runhtml = \"<script type=\\\"text/javascript\\\">\\n\" ;",
    "        string builderhtml;",
    "        ",
    "        try {",
    "            GLib.FileUtils.get_contents(BuilderApplication.configDirectory() + \"/resources/roo.builder.js\", out builderhtml);",
    "        } catch (Error e) {",
    "            builderhtml = \"\";",
    "        }",
    "        ",
    "",
    "        runhtml += builderhtml + \"\\n\";",
    "        ",
    "        ",
    "        runhtml += \"\\n\" +",
    "            \"Builder.saveHTML = function() {};\\n\" + ",
    "\t    \"Roo.onReady(function() {\\n\" +",
    "",
    "\t    \"Roo.XComponent.build();\\n\" +",
    "\t    \"});\\n\";",
    "\t",
    "\t",
    "        ",
    "",
    "        var ar = db.readForeignKeys(tbl);",
    "        var  generator = new Json.Generator ();",
    "        var  root = new Json.Node(Json.NodeType.OBJECT);",
    "        root.init_object(ar);",
    "        generator.set_root (root);",
    "        ",
    "        generator.pretty = true;",
    "        generator.indent = 4;",
    "        ",
    "        runhtml += \"\\n\" +",
    "        \" Roo.XComponent.on('buildcomplete', function() {\\n\" +",
    "         \"    Editor.\" + cls + \".panel.loadData(\" + generator.to_data (null) + \"); \" +",
    "        \"});\\n\";",
    "",
    "        ",
    "\t",
    "\t",
    "",
    "        runhtml += \"</script>\\n\" ;",
    "",
    "        print(runhtml);",
    "        // fix to make sure they are the same..",
    "        ",
    "        // need to modify paths",
    "",
    "        string inhtml;",
    "        try {",
    "            GLib.FileUtils.get_contents(",
    "                BuilderApplication.configDirectory() + \"/resources/roo.builder.html\"",
    "                    , out inhtml);",
    "        ",
    "        } catch (Error e) {",
    "            inhtml = \"\";",
    "        }",
    "        // fetch the json from the database...",
    "        ",
    "        //print(runhtml);",
    "        ",
    "        var html = inhtml.replace(\"</head>\", runhtml + // + this.runhtml + ",
    "            \"<script type=\\\"text/javascript\\\" src=\\\"resources://localhost/Editors/Editor.\" + cls + \".js\\\"></script>\" + ",
    "      ",
    "                        ",
    "        \"</head>\");",
    "        //print(\"LOAD HTML \" + html);",
    "        ",
    "         //var rootURL = _this.file.project.rootURL;",
    "   ",
    "        ",
    "        ",
    "        this.webview.el.load_html( html , ",
    "            //fixme - should be a config option!",
    "            \"xhttp://localhost/roobuilder/\"",
    "        );",
    "    ",
    "        ",
    "    ",
    "   ",
    "         var response_id = this.el.run();",
    "        ",
    "         if (response_id == 1) { // OK...",
    "             var loop = new MainLoop();",
    "             // run toBJS to get the data... (calls back into alert handler)",
    "                _this.result_json = \"\";",
    "                 this.webview.el.run_javascript.begin(\"Editor.\" + cls + \".panel.toBJS();\", null, (obj, res) => {",
    "                     try {",
    "                        this.webview.el.run_javascript.end(res);",
    "                    } catch(Error e) {",
    "                ",
    "                     }",
    "                     loop.quit();",
    "                 });",
    "                 loop.run();",
    "                 ret = _this.result_json;",
    "                 ",
    "             ",
    "    //           print(\"LOOP END?\");",
    "             // try and get the resopse...",
    "            break;",
    "         }",
    "        if (response_id < 1) {",
    "            this.el.hide();",
    "             return \"\";",
    "        }",
    "        // keep showing...?",
    "        continue;",
    "    }",
    "    ",
    "    // now we save it..",
    "    this.el.hide();",
    "    ",
    "    return ret;",
    "    ",
    "    ",
    "    ",
    "}",
    ""
   ]
  }
 ],
 "modOrder" : "",
 "name" : "DialogPluginWebkit",
 "parent" : "",
 "path" : "/home/alan/gitlive/roobuilder/src/Builder4/DialogPluginWebkit.bjs",
 "permname" : "",
 "title" : ""
}